#! /bin/sh

echo "=================== [$(date)] INITALIZING ==================="

. /usr/local/bin/inc

mkdir -p ${BASE}/pems \
	${BASE}/data/service/sasl2 ${BASE}/data/service/homedirs ${BASE}/data/service/mailboxes \
	${BASE}/postfix/data/ ${BASE}/postfix/spool/
chmod 755 ${BASE}/data/service/homedirs ${BASE}/data/service/mailboxes

for file in group passwd shadow
do
	cp -a ${SRC}/uid/${file} /run/${file}
done

if ! test -d ${BASE}/data/service
	then
		cp -a /usr/local/etc/service ${BASE}/data/
	fi
if ! test -f ${BASE}/data/service/used_domains.json
	then
		echo "{}" > ${BASE}/data/service/used_domains.json
	fi
chown -R 850: ${BASE}/data/service/users ${BASE}/data/service/sessions ${BASE}/data/service/*.json ${BASE}/data/service/*.eml

/usr/local/python/doms_runner.py -O remake_unix_files
/usr/local/python/root_runner.py -O install_unix_files

mkdir -p /run/exec/root /run/exec/doms ${BASE}/data/service/sessions
chmod 777 /run/exec/root /run/exec/doms ${BASE}/data/service/sessions
chown service: /run/exec/doms ${BASE}/data/service/sessions


${PYBASE}/merge_templates.py
. /run/templates/__include__
/usr/local/python/doms_runner.py -O remake_mail_files
/usr/local/python/root_runner.py -O install_mail_files

if ! test -d ${BASE}/data/service/homedirs/${POLICY_MANAGER_ACCOUNT}
	then
		mkdir -p ${BASE}/data/service/homedirs/${POLICY_MANAGER_ACCOUNT}
		chown 900: ${BASE}/data/service/homedirs/${POLICY_MANAGER_ACCOUNT}
	fi

if ! grep -q '^manager:' /etc/passwd
	then
		/usr/local/bin/user_create "manager" "12345" >/dev/null 2>&1
	fi

mkdir -p /run/pems
chmod 755 /run/pems
chown root:mail /run/pems

if ! test -s ${BASE}/pems/server.pem
	then
		${PYBASE}/make_server_pem.py \
			-f ${POLICY_SITE_FQDN} \
			-c ${POLICY_SITE_COUNTRY} \
			-l ${POLICY_SITE_LOCATION} \
			-o ${POLICY_SITE_ORG} \
			-u ${POLICY_SITE_ORG_UNIT} \
			-s ${POLICY_SITE_STATE} > ${BASE}/pems/server.pem
	fi
cp -a ${BASE}/pems/server.pem /run/pems/server.pem
chmod 644 /run/pems/server.pem


if ! test -f /etc/sasl2/smtpd.conf
	then
		{
		echo "pwcheck_method: auxprop"
		echo "auxprop_plugin: sasldb"
		echo "mech_list: PLAIN LOGIN CRAM-MD5 DIGEST-MD5 NTLM"
		} > /etc/sasl2/smtpd.conf
	fi

postfix set-permissions >/dev/null 2>&1

chown -R postfix: ${BASE}/postfix/data
for file in transport virtual
do
	pfx="${BASE}/postfix/data/${file}"
	touch ${pfx}
	rm -f ${pfx}.lmdb
	postmap ${BASE}/postfix/data/${file}
done


mkdir /run/nginx; chown nginx: /run/nginx

mkdir -p ${BASE}/data/rainloop
if ! test -f ${BASE}/data/rainloop/EMPTY
	then
		cp -a ${SRC}/data/. ${BASE}/data/rainloop/
	fi

RAINLOOP="${BASE}/data/rainloop/_data_/_default_"
dst="${RAINLOOP}/configs/application.ini"
src="/run/templates/application.ini"
tag="${RAINLOOP}/configs/.made_by_auto"
if ! test -f ${dst} -a -f ${tag} || ! test ${dst} -nt ${tag}
	then
		cp -a ${src} ${dst}
		touch -r ${dst} ${tag}
	fi

dst="${RAINLOOP}/domains/${POLICY_DEFAULT_MAIL_DOMAIN}.ini"
src="/run/templates/webmail.localhost.ini"
if ! test -f ${dst}; then rm -f ${RAINLOOP}/domains/*; cp -a ${src} ${dst}; fi

chmod 700 ${BASE}/data/rainloop
chown -R rainloop: ${BASE}/data/rainloop

echo "=================== [$(date)] STARTING ==================="
exec /sbin/init
