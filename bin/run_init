#! /bin/sh

echo "=================== [$(date)] INITALIZING ==================="

. /usr/local/bin/inc

cp -a ${SRC}/uid/* /run/${file}

if ! test -d ${BASE}/service -a ${BASE}/postfix -a ${BASE}/pems
	then
		cp -a /usr/local/etc/default_config/* ${BASE}/.
	fi

/usr/local/python/doms_runner.py -O remake_unix_files
/usr/local/python/root_runner.py -O install_system_files

mkdir -p /run/exec/root /run/exec/doms
chmod 770 /run/exec/root /run/exec/doms
chgrp service: /run/exec/doms /run/exec/root

${PYBASE}/merge_templates.py
. /run/templates/__include__
/usr/local/python/doms_runner.py -O remake_mail_files
/usr/local/python/root_runner.py -O install_system_files

mkdir -p /run/pems
chmod 755 /run/pems
chown root:mail /run/pems

mkdir /run/nginx; chown nginx: /run/nginx

if ! test -s ${BASE}/pems/server.pem
	then
		${PYBASE}/make_server_pem.py \
			-f ${POLICY_SITE_FQDN} \
			-c ${POLICY_SITE_COUNTRY} \
			-l ${POLICY_SITE_LOCATION} \
			-o ${POLICY_SITE_ORG} \
			-u ${POLICY_SITE_ORG_UNIT} \
			-s ${POLICY_SITE_STATE} > ${BASE}/pems/server.pem
	fi
cp -a ${BASE}/pems/server.pem /run/pems/server.pem
chmod 644 /run/pems/server.pem

postfix set-permissions >/dev/null 2>&1


mkdir -p ${BASE}/data/rainloop
if ! test -f ${BASE}/data/rainloop/EMPTY
	then
		cp -a ${SRC}/data/. ${BASE}/data/rainloop/
	fi

RAINLOOP="${BASE}/service/rainloop/_data_/_default_"
dst="${RAINLOOP}/configs/application.ini"
src="/run/templates/application.ini"
tag="${RAINLOOP}/configs/.made_by_auto"
if ! test -f ${dst} -a -f ${tag} || ! test ${dst} -nt ${tag}
	then
		cp -a ${src} ${dst}
		touch -r ${dst} ${tag}
		chown rainloop: ${dst} ${tag}
	fi

dst="${RAINLOOP}/domains/${POLICY_DEFAULT_MAIL_DOMAIN}.ini"
src="/run/templates/webmail.localhost.ini"
if ! test -f ${dst}
	then
		rm -f ${RAINLOOP}/domains/*
		cp -a ${src} ${dst}
		chown rainloop: ${dst}
	fi

echo "=================== [$(date)] STARTING ==================="

exec /sbin/init
